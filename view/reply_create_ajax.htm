<!--{json width:"680",title:"回复当前楼层"}-->
<style type="text/css">
.replyform dt {width: 7%;}
.replyform dd {width: 91%;}
</style>
<form action="?reply-create-fid-$fid-pid-$pid-toreplyid-$toreplyid-ajax-1.htm" method="post" id="reply_create_form_{$pid}_$toreplyid" class="replyform" target="_blank">
	<input type="hidden" name="FORM_HASH" value="{FORM_HASH}" />
	<!--{hook common_form_hash_after.htm}-->
	<dl>
		<!--{hook reply_create_subject_before.htm}-->
		
		<!--{if $toreplyid}-->
		<dt>回复：</dt>
		<dd>
			
			<a href_real="?you-index-uid-$touid.htm" target="_blank" href="?you-profile-uid-$touid-ajax-1.htm" class="ajaxdialog" ajaxdialog="{position: 5, modal: false, timeout: 1000, showtitle: false}" onclick="return false;" style="display: block" rel="nofollow">
				$tousername
			</a>
		</dd>
		<!--{/if}-->
		
		<dt><label for="subject_{$pid}_$toreplyid">内容：</label></dt>
		<dd style="position: relative;"><textarea name="subject" style="width: 595px; height: 100px;"></textarea></dd>
		
		<!--{hook reply_create_subject_after.htm}-->
		
		<dt></dt>
		<dd>
			<span style="width: 160px; float: right; text-align: right;" class="grey">最多字符：128个</span>
			<input type="submit" class="button bigblue" value="回复" id="reply_create_submit_{$pid}_$toreplyid" />
			<input type="button" class="button biggrey" value="取消" id="reply_create_cancel_{$pid}_$toreplyid" />
			<!--{hook reply_create_button_end.htm}-->
		</dd>
	</dl>
</form>

<script type="text/javascript">


function delay_execute(dialog, recall) {
	
	var jform = $('#reply_create_form_{$pid}_$toreplyid');
	$('textarea', jform).focus();
	$('textarea', jform).focus();
	var jsubmit = $('#reply_create_submit_{$pid}_$toreplyid');
	jsubmit.click(function() {
		jsubmit.disable();
		$('div.alert').remove();
		var postdata = jform.serialize();
		$.post(jform.attr('action'), postdata,  function(s){
			jsubmit.enable();
			var json = json_decode(s);
			if(error = json_error(json)) {alert(error); return false;}
			json = json.message;
			if(json.subject) {
				$('textarea', jform).alert(json.subject, {width: 300}).focus();
				return false;
			}
			var page = json.page;
			
			// hook reply_create_submit_after_js.htm
			
			dialog.set_body('<div class="ok">回复成功！</div><p><a href="?thread-index-fid-$fid-tid-$tid.htm">【点击查看】</a></p>');
			
			$('textarea', jform).val('');
			setTimeout(function(){
	 			dialog.close(true);
	 			
	 			// 直接 append...
	 			var div = $('#replylist_{$fid}_{$pid}');
	 			if(div.length == 0) {
	 				// 如果不存在，则创建 replylist div
	 				
	 				// copy from thread_index.htm
	 				var s = '<div class="replylist" fid="$post[fid]" pid="$post[pid]" replies="$post[replies]" totalpage="$post[totalpage]" id="replylist_{$post[fid]}_{$post[pid]}">\
							<table width="100%" cellpadding="2" class="noborder" style="table-layout: fixed;">\
							<tr>\
								<td class="bold"><span class="red replies" style="font-size: 18px">0</span> 条回复</td>\
								<td width="90" align="right"></td>\
								<td width="70" class="grey">时间</td>\
							</tr>\
							<tr><td colspan="3"><hr /></td></tr>\
							<tr>\
								<td colspan="3" class="loading" style="padding: 0px;"></td>\
							</tr>\
							</table>\
						</div>';
	 				// copy end
	 				
	 				$('div.mod[pid=$pid]').before(s);
	 				var div = $('#replylist_{$fid}_{$pid}');
	 			}
	 			var jtd = $('td.loading', div);
	 			var jlast = $(json.body).appendTo(jtd);
	 			var replies = intval($('span.replies', div).html());
	 			$('span.replies', div).html(replies + 1);
	 			function reply_hover(div) {
					// 盖楼的编辑，删除链接
					$('tr.reply', div).hover(function() {
						$('span.mod', this).show();
						$(this).addClass('bg2');
					}, function() {
						$('span.mod', this).hide();
						$(this).removeClass('bg2');
					});
				}
				reply_hover(jlast);
	 		}, 50);
		});
		return false;
	});
	
	
	$('#reply_create_cancel_{$pid}_$toreplyid').click(function() {
		dialog.close();
	});
	
	$('textarea', jform).keyup(function(e) {
		if(e.ctrlKey && e.which == 13 || e.which == 10) {
			$('#reply_create_submit_{$pid}_$toreplyid').trigger('click');
			return false;
		}
	});
	
	// hook reply_create_js_end.htm
	
	// hook common_form_hash_after_js.htm
}

</script>